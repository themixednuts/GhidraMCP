name: Dependency Update Validation

on:
  pull_request:
    branches: ["main"]

jobs:
  validate-dependency-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Determine whether this is a bot dependency PR
        run: |
          ACTOR="${{ github.actor }}"
          if [ "$ACTOR" = "dependabot[bot]" ] || [ "$ACTOR" = "renovate[bot]" ] || [ "$ACTOR" = "app/dependabot" ] || [ "$ACTOR" = "app/renovate" ]; then
            echo "BOT_DEP_PR=true" >> "$GITHUB_ENV"
            echo "Running full dependency validation for bot PR actor: $ACTOR"
          else
            echo "BOT_DEP_PR=false" >> "$GITHUB_ENV"
            echo "Skipping dependency-only validation for actor: $ACTOR"
          fi

      - uses: actions/checkout@v6
        if: env.BOT_DEP_PR == 'true'

      - name: Set up JDK 21
        if: env.BOT_DEP_PR == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Resolve pinned Ghidra release selector
        if: env.BOT_DEP_PR == 'true'
        run: |
          GHIDRA_RELEASE=$(mvn -q -DforceStdout help:evaluate -Dexpression=ghidra.version)
          MCP_BOM_VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=mcp.bom.version)
          echo "GHIDRA_RELEASE=${GHIDRA_RELEASE}" >> "$GITHUB_ENV"
          echo "MCP_BOM_VERSION=${MCP_BOM_VERSION}" >> "$GITHUB_ENV"
          echo "Pinned selector from pom.xml: ${GHIDRA_RELEASE}"
          echo "Pinned MCP Java SDK BOM version: ${MCP_BOM_VERSION}"

      - name: Check MCP SDK release drift
        if: env.BOT_DEP_PR == 'true'
        run: |
          LATEST_MCP_BOM=$(curl -fsSL https://repo1.maven.org/maven2/io/modelcontextprotocol/sdk/mcp-bom/maven-metadata.xml | grep -oPm1 '(?<=<latest>)[^<]+')
          echo "Latest MCP Java SDK BOM version from Maven Central: ${LATEST_MCP_BOM}"
          if [ "${MCP_BOM_VERSION}" != "${LATEST_MCP_BOM}" ]; then
            echo "::warning::MCP BOM in pom.xml (${MCP_BOM_VERSION}) is behind latest (${LATEST_MCP_BOM})."
          fi

      - name: Validate pinned bootstrap + full build
        if: env.BOT_DEP_PR == 'true'
        run: |
          mvn -f bootstrap.xml initialize -Dghidra.release=${GHIDRA_RELEASE}
          mvn spotless:check com.github.hazendaz.maven:xml-format-maven-plugin:xml-check
          mvn clean package

      - name: Validate latest bootstrap path
        if: env.BOT_DEP_PR == 'true'
        run: |
          mvn -f bootstrap.xml initialize -Dghidra.release=latest
          LATEST_GHIDRA=$(grep '^ghidra.bootstrap.version=' lib/.ghidra-bootstrap.properties | cut -d'=' -f2)
          echo "Latest resolved Ghidra version: ${LATEST_GHIDRA}"
          mvn -Dghidra.version=${LATEST_GHIDRA} -DskipTests compile

      - name: Restore pinned bootstrap state
        if: env.BOT_DEP_PR == 'true'
        run: mvn -f bootstrap.xml initialize -Dghidra.release=${GHIDRA_RELEASE}

      - name: Dependency validation not required for this PR actor
        if: env.BOT_DEP_PR != 'true'
        run: echo "Dependency update validation only runs for Dependabot/Renovate PRs."
