name: Dependency Update Validation

on:
  pull_request:
    branches: ["main"]

jobs:
  validate-dependency-updates:
    if: github.actor == 'dependabot[bot]' || github.actor == 'renovate[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Resolve pinned Ghidra release selector
        run: |
          GHIDRA_RELEASE=$(mvn -q -DforceStdout help:evaluate -Dexpression=ghidra.version)
          echo "GHIDRA_RELEASE=${GHIDRA_RELEASE}" >> "$GITHUB_ENV"
          echo "Pinned selector from pom.xml: ${GHIDRA_RELEASE}"

      - name: Validate pinned bootstrap + full build
        run: |
          mvn -f bootstrap.xml initialize -Dghidra.release=${GHIDRA_RELEASE}
          mvn spotless:check com.github.hazendaz.maven:xml-format-maven-plugin:xml-check
          mvn clean package

      - name: Validate latest bootstrap path
        run: |
          mvn -f bootstrap.xml initialize -Dghidra.release=latest
          LATEST_GHIDRA=$(grep '^ghidra.bootstrap.version=' lib/.ghidra-bootstrap.properties | cut -d'=' -f2)
          echo "Latest resolved Ghidra version: ${LATEST_GHIDRA}"
          mvn -Dghidra.version=${LATEST_GHIDRA} -DskipTests compile

      - name: Restore pinned bootstrap state
        run: mvn -f bootstrap.xml initialize -Dghidra.release=${GHIDRA_RELEASE}
